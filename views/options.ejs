<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/option.css" rel="stylesheet">
</head>
<body>
    <section style="background-color: #eee;">
        <div class="container py-5">
            <div class="card">
                <div class="card-body">
                    <div class="row d-flex justify-content-center pb-5">
                        <div class="py-4 d-flex name-shop" style="margin-top: -2%;margin-left:3%; font-size: 30px;">
                            <span class="far fa-check-square pe-2"></span><b>EZDOG</b> |
                            <span class="ps-2" style="font-size: 30px;">Pay</span>
                        </div>
                        <div class="product-buy">
                          <% products.forEach(product => { %>
                            <div class="card rounded-3 mb-4 product custom-margin-left">
                                <div class="card-body p-4">
                                    <div class="row d-flex justify-content-between align-items-center">
                                        <div class="col-md-2 col-lg-2 col-xl-2">
                                            <img src="/img/def.png" class="img-fluid rounded-3" alt="Avatar"/>
                                        </div>
                                        <div class="col-md-10 col-lg-10 col-xl-10">
                                            <div class="row align-items-center">
                                                <div class="col-md-6 product-title">
                                                    <strong><p class="mb-2"><%= product.name %></p></strong>
                                                </div>
                                                <div class="d-flex quantity-display">
                                                    x<%= product.quantity %>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                        </div>
                        <div class="col-md-7 col-xl-5 mb-4 mb-md-0">
                            <div class="pt-2">
                                <form class="pb-3">
                                    <div class="d-flex flex-row pb-3">
                                        <div class="d-flex align-items-center pe-2">
                                            <input class="form-check-input" type="radio" name="paymentMethod" id="paymentMethodCash"
                                                value="cash" aria-label="..." checked />
                                        </div>
                                        <div class="rounded border d-flex w-100 p-3 align-items-center">
                                            <p class="mb-0">
                                                <i class="fab fa-cc-visa fa-lg text-primary pe-2"></i>Thanh toán bằng tiền mặt
                                            </p>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-row">
                                        <div class="d-flex align-items-center pe-2">
                                            <input class="form-check-input" type="radio" name="paymentMethod" id="paymentMethodCard"
                                                value="card" aria-label="..." />
                                        </div>
                                        <div class="rounded border d-flex w-100 p-3 align-items-center">
                                            <p class="mb-0">
                                                <i class="fab fa-cc-mastercard fa-lg text-body pe-2"></i>Thanh toán bằng thẻ
                                            </p>
                                        </div>
                                    </div>
                                </form>
                                <button type="button" onclick="confirmPayment()" class="btn btn-primary btn-block btn-lg">Tiến hành thanh toán</button>
                            </div>
                        </div>
                        <div class="col-md-5 col-xl-4 offset-xl-1">
                            <div class="py-4 d-flex justify-content-end">
                                <h6><a href="/cart">Hủy và quay lại trang web</a></h6>
                            </div>
                            <div class="rounded d-flex flex-column p-2 bg-body-tertiary">
                              <div class="p-2 me-3">
                                  <h4>Hóa đơn</h4>
                              </div>
                          	
                              <!-- Hiển thị từng sản phẩm -->
                              <% products.forEach(product => { %>
                                  <div class="p-2 d-flex pt-3">
                                      <div class="col-8"><%= product.name %> x<%= product.quantity %></div>
                                      <div class="ms-auto">
                                          <b class="text-success"><%= formatCurrency(product.price) %> VNĐ</b>
                                      </div>
                                  </div>
                              <% }); %>
                          	
                              <div class="p-2 d-flex pt-3">
                                  <div class="col-8">Tổng tiền</div>
                                  <div class="ms-auto">
                                      <b class="text-success"><%= formatCurrency(totalAmount.toFixed(0)) %> VNĐ</b>
                                  </div>
                              </div>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal xác nhận thanh toán -->
    <div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmPaymentModalLabel">Xác nhận thanh toán</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn thanh toán đơn hàng này?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="confirmPaymentButton">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmPayment() {
    const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
    const selectedProducts = [...document.querySelectorAll('.product')].map(product => {
        return {
            name: product.querySelector('.product-title').innerText,
            quantity: parseInt(product.querySelector('.quantity-display').innerText.replace('x', '').trim(), 10) // Lấy số lượng
        };
    });

    console.log(selectedPaymentMethod, selectedProducts);

    const confirmModal = new bootstrap.Modal(document.getElementById('confirmPaymentModal'));
    confirmModal.show();

    // Xử lý khi người dùng xác nhận thanh toán
    document.getElementById('confirmPaymentButton').onclick = function() {
      const userId = '<%= user.id %>'; // Chỉnh sửa để sử dụng userId từ EJS
      const totalAmount = parseFloat('<%= totalAmount %>'); // Chỉnh sửa để sử dụng totalAmount từ EJS

        // Gửi dữ liệu thanh toán về server
        fetch('/payment/confirm-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                userId: userId,
                paymentMethod: selectedPaymentMethod,
                products: selectedProducts,
                totalAmount: totalAmount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/success'; 
            } else {
                alert(data.message || 'Có lỗi xảy ra, vui lòng thử lại.');
            }
        })
        .catch(error => {
            console.error('Có lỗi xảy ra:', error);
            alert('Có lỗi xảy ra, vui lòng thử lại.');
        });

        confirmModal.hide(); 
    };
}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="option.js"></script>
</body>
</html>
